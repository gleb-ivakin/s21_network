## Part 1. Инструмент ipcalc
### 1.1. Сети и маски
+ Адрес сети 192.167.38.54/13 (указан в поле *Network*)
![](img/part_1/ipcalc1.png)
+ Перевод маски 255.255.255.0 в префиксную и двоичную запись. Префиксная - /24, двоичная - на скриншоте.
![](img/part_1/ipcalc2.png)
+ /15 в обычную и двоичную
![](img/part_1/ipcalc3.png)
+ 11111111.11111111.11111111.11110000 в обычную и префиксную. Обычная - 256.256.256.240, префиксная - /28. Проверка на скриншоте.
![](img/part_1/ipcalc4.png)

### 1.2. localhost
+ *"Определить и записать в отчёт, можно ли обратиться к приложению, работающему на localhost, со следующими IP: 194.34.23.100, 127.0.0.2, 127.1.0.1, 128.0.0.1."*  
...  
Localhost определяется диапазоном адресов 127.0.0.0 — 127.255.255.255, следовательно:  
194.34.23.100 - нельзя,  
127.0.0.2 - можно,  
127.1.0.1 - можно,  
128.0.0.1 - нельзя.  

### 1.3. Диапазоны и сегменты сетей
+ *"какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: 10.0.0.45, 134.43.0.2, 192.168.4.2, 172.20.250.4, 172.0.2.1, 192.172.0.1, 172.68.0.2, 172.16.255.255, 10.10.10.10, 192.169.168.1"*  
...   
Для локальных адресов определены диапазоны 10.0.0.0 — 10.255.255.255 (10.0.0.0/8), 172.16.0.0 — 172.31.255.255 (172.16.0.0/12), 192.168.0.0 — 192.168.255.255 (192.168.0.0/16), 127.0.0.0 — 127.255.255.255, следовательно:  
10.0.0.45 - частный,  
134.43.0.2 - публичный,  
192.168.4.2 - частный,  
172.20.250.4 - частный,  
172.0.2.1 - публичный,  
192.172.0.1 - публичный,  
172.68.0.2 - публичный,  
172.16.255.255 - частный,  
10.10.10.10 - частный,  
192.169.168.1 - публичный.  

+ *"какие из перечисленных IP адресов шлюза возможны у сети 10.10.0.0/18: 10.0.0.1, 10.10.0.2, 10.10.10.10, 10.10.100.1, 10.10.1.255"*  
...  
![](img/part_1/ipcalc5.png)
Из вывода команды ipcalc мы видим, что в данной сети IP-адреса могут принимать значение от 10.10.0.1 до 10.10.63.254. Следовательно:  
10.0.0.1 - невозможен,   
10.10.0.2 - возможен,  
10.10.10.10 - возможен,  
10.10.100.1 - невозможен,  
10.10.1.255 - возможен.  

## Part 2. Статическая маршрутизация между двумя машинами
+ С помощью команды ip a посмотреть существующие сетевые интерфейсы.  
+ ws1:  
![](img/part_2/ip_a_ws1.png)
+ ws2:  
![](img/part_2/ip_a_ws2.png)  

+ Описать сетевой интерфейс, соответствующий внутренней сети, на обеих машинах и задать следующие адреса и маски: 
+ ws1 - 192.168.100.10, маска /16
![](img/part_2/yaml_ws1.png)
+ ws2 - 172.24.116.8, маска /12  
![](img/part_2/yaml_ws2.png)  

+ Выполнить команду netplan apply для перезапуска сервиса сети.   
+ ws1:
![](img/part_2/apply_ws1.png)
+ ws2: 
![](img/part_2/apply_ws2.png)

### 2.1. Добавление статического маршрута вручную
+ Добавить статический маршрут от одной машины до другой и обратно при помощи команды вида ip r add. Пропинговать соединение между машинами.  
+ ws1:
![](img/part_2/ping1.png)
+ ws2:
![](img/part_2/ping2.png)

### 2.2. Добавление статического маршрута с сохранением
+ Добавить статический маршрут от одной машины до другой с помощью файла etc/netplan/00-installer-config.yaml. 
+ ws1:
![](img/part_2/static1.png)
+ ws2:
![](img/part_2/static2.png)

+ Пропинговать соединение между машинами.
+ ws1:
![](img/part_2/ping_st_1.png)
+ ws2:  
![](img/part_2/ping_st_2.png)

## Part 3. Утилита iperf3
### 3.1. Скорость соединения
+ *Перевести и записать в отчёт: 8 Mbps в MB/s, 100 MB/s в Kbps, 1 Gbps в Mbps.*  
8 Mbps = 1 MB/s  
100 MB/s = 100000 Kbps  
1 Gbps = 1000 Mbps  

### 3.2. Утилита iperf3
+ Измерить скорость соединения между ws1 и ws2.
+ Запускаем сервер на ws1:
![](img/part_3/iperf1.png)
+ Подключаемся к серверу на ws2:
![](img/part_3/iperf2.png)

## Part 4. Сетевой экран
### 4.1. Утилита iptables
+ firewall.sh на ws1:
![](img/part_4/fw1.png)
+ firewall.sh на ws2:
![](img/part_4/fw2.png)
+ Запуск скрипта на ws1:
![](img/part_4/run1.png)
+ Запуск скрипта на ws2:
![](img/part_4/run2.png)
+ *В отчёте описать разницу между стратегиями, применёнными в первом и втором файлах.*  
В первом случае мы сперва запретили пингование машины, а потом его разрешили, а во втором случае - наоборот.

### 4.2. Утилита nmap
+ Командой ping найти машину, которая не "пингуется".
![](img/part_4/ping.png)
+ Утилитой nmap показать, что хост машины запущен.
![](img/part_4/nmap.png)

## Part 5. Статическая маршрутизация сети
### 5.1. Настройка адресов машин
+ *Настроить конфигурации машин в etc/netplan/00-installer-config.yaml согласно сети на рисунке.*
+ ws11  
![](img/part_5/yaml_ws11.png)
+ r1  
![](img/part_5/yaml_r1.png)
+ r2  
![](img/part_5/yaml_r2.png) 
+ ws21  
![](img/part_5/yaml_ws21.png)
+ ws22  
![](img/part_5/yaml_ws22.png)
+ *Перезапустить сервис сети. Если ошибок нет, то командой ip -4 a проверить, что адрес машины задан верно.*
+ ws11  
![](img/part_5/ip4a_ws11.png)
+ r1  
![](img/part_5/ip4a_r1.png)
+ r2  
![](img/part_5/ip4a_r2.png)
+ ws21  
![](img/part_5/ip4a_ws21.png)
+ ws22  
![](img/part_5/ip4a_ws22.png)
+ *Также пропинговать ws22 с ws21.*
![](img/part_5/ping_ws22_from_ws21.png)  
+ *Аналогично пропинговать r1 с ws11.*  
![](img/part_5/ping_r1_from_ws11.png)

### 5.2. Включение переадресации IP-адресов.
+ *Для включения переадресации IP, выполните команду на роутерах:*
*sysctl -w net.ipv4.ip_forward=1*
+ r1  
![](img/part_5/sysctl_r1.png)
+ r2  
![](img/part_5/sysctl_r2.png)
+ *Откройте файл /etc/sysctl.conf и добавьте в него следующую строку:*
*net.ipv4.ip_forward = 1*
+ r1  
![](img/part_5/sysctl_conf_r1.png)
+ r2  
![](img/part_5/sysctl_conf_r2.png)

### 5.3. Установка маршрута по-умолчанию
+ *Настроить маршрут по-умолчанию (шлюз) для рабочих станций. Для этого добавить gateway4 [ip роутера] в файле конфигураций*
+ ws11  
![](img/part_5/gateway4_ws11.png)
+ ws21  
![](img/part_5/gateway4_ws21.png)
+ ws22  
![](img/part_5/gateway4_ws22.png)
+ *Вызвать ip r и показать, что добавился маршрут в таблицу маршрутизации*
+ ws11  
![](img/part_5/ipr_ws11.png)
+ ws21  
![](img/part_5/ipr_ws21.png)
+ ws22  
![](img/part_5/ipr_ws22.png)
+ *Пропинговать с ws11 роутер r2 и показать на r2, что пинг доходит. Для этого использовать команду:*
*tcpdump -tn -i eth1*
+ ![](img/part_5/ping_r2_from_ws11.png)

### 5.4. Добавление статических маршрутов
+ *Добавить в роутеры r1 и r2 статические маршруты в файле конфигураций.*
+ r1  
![](img/part_5/static_route_r1.png)
+ r2  
![](img/part_5/static_route_r2.png)
+ *Вызвать ip r и показать таблицы с маршрутами на обоих роутерах.*
+ r1  
![](img/part_5/ipr_r1.png)
+ r2  
![](img/part_5/ipr_r2.png)
+ *Запустить команды на ws11:*
*ip r list 10.10.0.0/[маска сети] и ip r list 0.0.0.0/0*
![](img/part_5/ipr_list_ws11.png)

### 5.5. Построение списка маршрутизаторов
+ *Запустить на r1 команду дампа:*
*tcpdump -tnv -i eth0*  
(я, соответственно, использовал команду tcpdump -tnv -i enp0s8 и добавил к ней команду | less -N, чтобы прочитать весь вывод)  
+ начало вывода  
![](img/part_5/tcpdump_r1_1.png)
+ конец вывода  
![](img/part_5/tcpdump_r1_2.png)
+ *При помощи утилиты traceroute построить список маршрутизаторов на пути от ws11 до ws21*  
![](img/part_5/traceroute_ws11.png)

### 5.6. Использование протокола ICMP при маршрутизации
+ *Запустить на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды:*
*tcpdump -n -i eth0 icmp*  
![](img/part_5/tcpdump_icmp_r1.png)
+ *Пропинговать с ws11 несуществующий IP (например, 10.30.0.111) с помощью команды:*
*ping -c 1 10.30.0.111*  
![](img/part_5/ping_non-existent_ws11.png)

## Part 6. Динамическая настройка IP с помощью DHCP
+ *Для r2 настроить в файле /etc/dhcp/dhcpd.conf конфигурацию службы DHCP:*  
+ *1) указать адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети.*  
![](img/part_6/dhcpd-conf_r2.png)
+ *2) в файле resolv.conf прописать nameserver 8.8.8.8.*  
![](img/part_6/resolv-conf_r2.png)
+ *Перезагрузить службу DHCP командой systemctl restart isc-dhcp-server.*  
![](img/part_6/restart_dhcp_r2.png)
+ *Машину ws21 перезагрузить при помощи reboot и через ip a показать, что она получила адрес.*  
![](img/part_6/reboot_and_ip_a_ws21.png)
+ *Также пропинговать ws22 с ws21.*  
![](img/part_6/ping_ws22_from_ws21.png)
+ *Указать MAC адрес у ws11, для этого в etc/netplan/00-installer-config.yaml надо добавить строки: macaddress: 10:10:10:10:10:BA, dhcp4: true*  
![](img/part_6/yaml_ws_1.png)

+ *Для r1 настроить аналогично r2, но сделать выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Провести аналогичные тесты*  
+ Меняем на r1 файл конфигурации DHCP  
![](img/part_6/dhcpd-conf_r1.png)
+ Перезапускаем эту службу  
![](img/part_6/restart_r1.png)
+ Перезагружаем ws11 и убеждаемся, что она получила нужный mac-адрес.  
![](img/part_6/ip_a_ws11.png)
+ Пингуем ws11 с машины r1  
![](img/part_6/ping_ws11_from_r1.png)
+ Пингуем ws22 с машины ws11  
![](img/part_6/ping_ws22_from_ws11.png)

+ *Запросить с ws21 обновление ip адреса.*
+ Просматриваем текущий IP с помощью команды ip a.  
![](img/part_6/ipa_ws21.png)
+ Командой sudo dhclient -r enp0s10 удаляем имеющийся IP адрес для данного интерфейса.  
![](img/part_6/dhclient_r_ws21.png)
+ Командой sudo dhclient enp0s10 получаем новый IP.  
![](img/part_6/dhclient_ws21.png)
+ (мы воспользовались опциями release/renew dhcp-сервера).

## Part 7. NAT
+ *В файле /etc/apache2/ports.conf на ws22 и r1 изменить строку Listen 80 на Listen 0.0.0.0:80, то есть сделать сервер Apache2 общедоступным*
![](img/part_7/ports_conf.png)

+ *Запустить веб-сервер Apache командой service apache2 start на ws22 и r1*
+ ws22
![](img/part_7/apache2_start_ws22.png)
+ r1
![](img/part_7/apache2_start_r1.png)

+ *Добавить в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:*  
*1) Удаление правил в таблице filter - iptables -F*  
*2) Удаление правил в таблице "NAT" - iptables -F -t nat*  
*3) Отбрасывать все маршрутизируемые пакеты - iptables --policy FORWARD DROP*  
Создаём файл /etc/firewall.sh  
![](img/part_7/firewall_sh_r2.png)
+ *Запускать файл также, как в Части 4*  
![](img/part_7/firewall_run_r2.png)
+ *Проверить соединение между ws22 и r1 командой ping*  
![](img/part_7/ping_bad_ws22.png)
+ *Добавить в файл ещё одно правило:*  
*4) Разрешить маршрутизацию всех пакетов протокола ICMP*  
![](img/part_7/firewall_forward_r2.png)
+ *Проверить соединение между ws22 и r1 командой ping*  
![](img/part_7/ping_good_ws22.png)

+ *Добавить в файл ещё два правила:*  
*5) Включить SNAT, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0)*  
*6) Включить DNAT на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети*  
+ [](img/part_7/firewall_snat_dnat.png)
+ *Проверить соединение по TCP для SNAT, для этого с ws22 подключиться к серверу Apache на r1 командой:*  
*telnet [адрес] [порт]*  
![](img/part_7/telnet_ws22.png)
+ *Проверить соединение по TCP для DNAT, для этого с r1 подключиться к серверу Apache на ws22 командой telnet (обращаться по адресу r2 и порту 8080)*  
![](img/part_7/telnet_r1.png)

## Part 8. Дополнительно. Знакомство с SSH Tunnels
+ *Запустить веб-сервер Apache на ws22 только на localhost (то есть не изменять файл /etc/apache2/ports.conf или, если был изменен ранее, вернуть строку Listen 80)*  
![](img/part_8/apache_80_ws22.png)
+ Перезапускаем апач  
![](img/part_8/apache_restart.png)
+ *Воспользоваться Local TCP forwarding с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21*  

![](img/part_8/ssh_ws21.png)
+ *Воспользоваться Remote TCP forwarding c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11*  
![](img/part_8/ssh_ws11.png)